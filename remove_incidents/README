Скрипт смотрит на объем файла БД. Если он превышает заданный предел (available_space), скрипт смотрит сколько занимают данные в базе. Затем скрипт считает сколько событий надо удалить, получает их id и удаляет. Если нужно удалить больше 1000 записей, то операция будет выполнена в несколько итераций, поскольку запросом /api/v2/incidents/ максимально выводится только 1000 инцидентов. Для удаления используется /api/v2/incidents/delete_by_ids.

Критерием прекращения работы скрипта является объем данных внутри базы (объем файла БД меняться не будет). Он не должен превышать предел, который вычисляется как:

db_max_data_size = int((settings['available_space'] - db_index_size) * (100 - settings['min_free_space']) / 100),где:

'available_space' - значение максимального объема файла БД, задаваемое а конфигурационном файле в МБ;

'min_free_space' - минимальный объем свободного места в БД, задается в процентах.

'auth_type' - (0 - пользовательская, 1 - ldap).

Для работы скрипта необходим доступ к самой БД.


remove_incidetns.exe get - генерит фаил настроек parameters, который нужно отредактировать для последующих запусков

{
"core_url": "https://192.168.0.2",
"core_user": "Administrator",
"core_pass": "P@ssw0rd",
"db_server": "192.168.0.2",
"sql_browser_port": 1434,
"db_user": "sa",
"db_password": "P@ssw0rdP@ssw0rd",
"db_name": "MaxPatrol_IncidentReadModel",
"available_space": 10000,
"min_free_space": 10,
"auth_type": 0
} 
